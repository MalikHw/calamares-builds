name: Ultimate Calamares Build (Fixed Deps)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

  install_deps:
    needs: setup
    runs-on: ubuntu-latest
    steps:
    - name: Configure Ubuntu repositories
      run: |
        # First make sure basic system is configured
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends software-properties-common
        sudo add-apt-repository main
        sudo add-apt-repository universe
        sudo add-apt-repository multiverse
        sudo add-apt-repository restricted
        sudo apt-get update -y

    - name: Install build tools (the real way)
      run: |
        sudo apt-get install -y --install-recommends --install-suggests \
          gcc \
          g++ \
          libc6-dev \
          dpkg-dev \
          # These together replace build-essential
          cmake \
          ninja-build \
          git \
          pkg-config \
          gettext

    - name: Install Qt5 and KDE dependencies
      run: |
        sudo apt-get install -y --install-recommends --install-suggests \
          qtbase5-dev \
          qttools5-dev \
          qtdeclarative5-dev \
          qt5-qmake \
          qt5-default \
          libqt5webengine5 \
          libqt5webenginecore5 \
          libqt5webenginewidgets5 \
          libkf5config-dev \
          libkf5coreaddons-dev \
          libkf5i18n-dev

    - name: Install system libraries
      run: |
        sudo apt-get install -y --install-recommends --install-suggests \
          python3-dev \
          libyaml-cpp-dev \
          libkpmcore-dev \
          libparted-dev \
          libcryptsetup-dev

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install \
          pyyaml \
          jsonschema \
          requests \
          distro \
          pybind11

  clone:
    needs: install_deps
    runs-on: ubuntu-latest
    steps:
    - name: Full recursive clone
      run: |
        git clone --recursive https://codeberg.org/calamares/calamares.git
        cd calamares
        git submodule update --init --recursive
        echo "CALAMARES_VERSION=$(git describe --tags --always)" >> $GITHUB_ENV
        echo "CALAMARES_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

  build:
    needs: clone
    runs-on: ubuntu-latest
    steps:
    - name: Configure and build
      run: |
        cd calamares
        mkdir build
        cd build
        cmake -GNinja .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DQT_MAJOR_VERSION=5 \
          -DWITH_PYTHONQT=ON \
          -DWITH_QML=ON
        ninja -j$(nproc)

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Create package
      run: |
        cd calamares/build
        DESTDIR=/tmp/calamares-pkg ninja install
        tar -czvf /tmp/calamares.tar.gz -C /tmp/calamares-pkg .
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: calamares-build
        path: /tmp/calamares.tar.gz
