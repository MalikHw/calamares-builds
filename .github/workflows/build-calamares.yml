name: Build Calamares (Full Qt5 Build)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set build timestamp (GMT+1)
        id: vars
        run: |
          export TZ=Europe/Paris
          echo "DATE_TAG=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "DATE_TITLE=$(date +'%Y-%m-%d %H:%M:%S GMT+1')" >> $GITHUB_ENV

      - name: Install dependencies (Full Qt5 + KDE)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake ninja-build extra-cmake-modules gettext pkg-config \
            qtbase5-dev qtdeclarative5-dev qttools5-dev qttools5-dev-tools \
            qml-module-qtquick-controls qml-module-qtquick-controls2 \
            qml-module-qtquick-layouts qml-module-qtquick-window2 qml-module-qtgraphicaleffects \
            libkf5config-dev libkf5coreaddons-dev libkf5i18n-dev libkf5iconthemes-dev \
            libkf5parts-dev libkf5service-dev libkf5solid-dev libkf5plasma-dev \
            libkf5crash-dev libkf5package-dev libkf5notifications-dev libkf5networkmanager-dev \
            libpolkit-qt5-1-dev libyaml-cpp-dev libboost-all-dev \
            python3-dev python3-pyqt5 python3-pyqt5.qtsvg python3-pyqt5.qtquick python3-yaml \
            libappstreamqt-dev libpwquality-dev libnm-dev libcryptsetup-dev libparted-dev \
            os-prober rsync squashfs-tools dosfstools e2fsprogs btrfs-progs xfsprogs \
            f2fs-tools jfsutils reiserfsprogs nilfs-tools udftools

      - name: Clone Calamares from Codeberg
        run: git clone --recursive https://codeberg.org/calamares/calamares.git

      - name: Build & install Calamares (Qt5 Full)
        run: |
          cd calamares
          mkdir build && cd build
          cmake -G Ninja \
            -DWITH_ALL_MODULES=ON \
            -DWITH_QT6=OFF \
            -DWITH_PYTHON=ON \
            -DWITH_PYBIND11=ON \
            -DWITH_QML=ON \
            -DINSTALL_CONFIG=ON \
            -DINSTALL_POLKIT=ON \
            -DBUILD_CRASH_REPORTING=ON \
            -DBUILD_SCHEMA_TESTING=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/tmp/calamares \
            ..
          ninja
          ninja install

      - name: Package install directory
        run: tar -czf calamares-${{ env.DATE_TAG }}.tar.gz -C /tmp/calamares .

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.DATE_TAG }}
          name: "${{ env.DATE_TITLE }} build"
          body: "Automated full-featured Qt5 Calamares build"
          files: calamares-${{ env.DATE_TAG }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup runner
        run: sudo rm -rf /tmp/* ~/calamares ~/work
