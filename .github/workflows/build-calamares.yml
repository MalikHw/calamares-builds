name: Build Calamares

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set build timestamp (GMT+1)
        id: vars
        run: |
          export TZ=Europe/Paris
          echo "DATE_TAG=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "DATE_TITLE=$(date +'%Y-%m-%d %H:%M:%S GMT+1')" >> $GITHUB_ENV

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y git cmake ninja-build extra-cmake-modules qtbase5-dev qtdeclarative5-dev qml-module-qtquick-controls qml-module-qtquick-controls2 qml-module-qtquick-layouts qml-module-qtquick2 libkf5i18n-dev libkf5config-dev libkf5coreaddons-dev libkf5crash-dev libkf5parts-dev libkf5networkmanagerqt-dev libpolkit-agent-1-dev libpolkit-qt5-1-dev libyaml-cpp-dev libparted-dev libboost-all-dev python3-dev python3-pyqt5 python3-pyqt5.qtsvg python3-pyqt5.qtquick python3-yaml libqt5svg5-dev squashfs-tools libkf5package-dev libarchive-dev

      - name: Clone Calamares from Codeberg
        run: git clone --recursive https://codeberg.org/calamares/calamares.git

      - name: Build & install Calamares
        run: |
          cd calamares
          mkdir build && cd build
          cmake -G Ninja -DWITH_ALL_MODULES=ON -DCMAKE_INSTALL_PREFIX=/tmp/calamares ..
          ninja
          ninja install

      - name: Package install directory
        run: tar -czf calamares-${{ env.DATE_TAG }}.tar.gz -C /tmp/calamares .

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.DATE_TAG }}
          name: "${{ env.DATE_TITLE }} build"
          body: "Automated build"
          files: calamares-${{ env.DATE_TAG }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup runner
        run: sudo rm -rf /tmp/* ~/calamares ~/work
